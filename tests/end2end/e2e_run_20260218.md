# E2E Test Run — 2026-02-18

Agent: Claude Code (Opus 4.6) calling `winctl` CLI
Target: Outlook (olk.exe) — New Outlook
Feature under test: `--infer` (Tier 1+ structural inference)

## Test Case 1: Compose Email with Table Operations

| Step | Action | Result | Status |
|------|--------|--------|--------|
| 1 | `winctl --window outlook state` → focus Outlook | Window focused, 375 elements detected | PASS |
| 2 | `winctl click 71` → click "New mail" | Compose pane opened with To/Cc/Subject/Body fields | PASS |
| 3 | `winctl click 278` → click message body editor | Editor focused, cursor active | PASS |
| 4 | `winctl click 68` (Insert tab) → `winctl click 83` (Table button) | Table dropdown grid appeared | PASS |
| 5 | `winctl click 292` → select 3x3 in table grid | 3x3 table inserted (9 DataItem cells + 1 Table) | PASS |
| 6 | `winctl keyboard "{CTRL}a"` → select entire table | Table selected (Ctrl+A in table context) | PASS |
| 7 | `winctl --infer state` → find ResizeHandle → `winctl drag-at` | **Inferred ResizeHandle** at table bottom-right. Dragged resize handle, table width changed (right edge -2628 → -2436). **Tier 1+ worked.** | PASS |
| 8 | Click table cell → "Table" ribbon tab → "Insert below" | Row inserted. Cell count 9→12 (3x3→4x3). Used ribbon path since right-click only shows mini toolbar. | PASS |
| 9 | `winctl click 262` → Discard | Compose dismissed, returned to mail reading view | PASS |

**TC1 Result: 9/9 PASS**

### TC1 Issues Found
- **Issue 1**: JSON parse error in `_parse_response` — LLM returned `[]` followed by reasoning text. Fixed by extracting outermost `[...]` bracket pair.
- **Issue 2**: Inferred elements had `[None]` IDs. Fixed by adding sequential ID assignment in `detect()`.
- **Issue 3**: Negative coordinates need `--` separator: `winctl drag-at -- -2632 593 -2432 693`
- **Issue 4**: CLI options must come before `--`: `winctl drag-at --duration 1.5 -- -2632 593 ...`
- **Issue 5**: New Outlook right-click context menu only exposes mini formatting toolbar via UIA — no table row/column insertion options. Workaround: use Table ribbon tab.
- **Issue 6 (Bug 11)**: `winctl click <index>` on contextual Table ribbon tab caused the tab to disappear. Root cause: `ControlReceiver.__init__` unconditionally calls `set_focus()` on target control → shifts DOM focus in WebView2 → React removes contextual tab. `click-at` with coordinates worked because it only does window-level focus. Fixed by making `set_focus()` on-demand (see Bug 11 in E2E_ISSUES.md).

## Test Case 1 Re-run (post Bug 11 fix)

| Step | Action | Result | Status |
|------|--------|--------|--------|
| 1 | `winctl --window outlook state` | Window focused, elements detected | PASS |
| 2 | `winctl click 71` → New mail | Compose pane opened | PASS |
| 3 | Click body editor | Editor focused | PASS |
| 4 | `winctl click 68` (Insert tab) → `winctl click 83` (Table button) | Table grid appeared | PASS |
| 5 | Click 3x3 table grid | 3x3 table inserted (12 DataItems + Table) | PASS |
| 6 | `winctl keyboard "{CTRL}a"` → Ctrl+A | Table selected (blue highlight) | PASS |
| 7 | `winctl --infer state` → drag resize handle | Table resized (right edge -2628 → -2434). Tier 1+ worked. | PASS |
| 8 | `winctl click 313` (cell) → `winctl click 72` (Table tab) → `winctl click 101` (Insert below) | **Table tab [72] survived `click <index>`!** Row inserted: 12→16 DataItems. **Bug 11 fix validated.** | PASS |
| 9 | `winctl click 262` → Discard → OK | Compose dismissed, returned to mail reading view | PASS |

**TC1 Re-run Result: 9/9 PASS — Bug 11 fix validated**

Key difference from initial run: Step 8 now uses `click <index>` on the contextual Table tab instead of coordinate workaround. The `set_focus()` on-demand fix prevents DOM focus shift that previously destroyed the contextual tab.

---

## Test Case 2: File Menu Operations

| Step | Action | Result | Status |
|------|--------|--------|--------|
| 1 | `winctl click 123` → click first message (Google security alert) | Reading pane showed email: From: Google, To: ryanma@outlook.com, Message body | PASS |
| 2 | `winctl click 61` → File button | File menu (Backstage) opened: Account info, Save as, Print, Open and export, Settings, About Outlook, Exit | PASS |
| 3 | `winctl click 312` → Account info | Settings → Accounts page: email `ronleonearth@hotmail.com`, Outlook.com, Add account, Manage | PASS |
| 4 | File → `winctl click 314` (Save as) → `winctl click 322` (Save as EML) | Save As dialog ("另存为") appeared with file name and save type fields | PASS |
| 5 | File → Save as → `winctl click 323` (Save as MSG) | Save As dialog ("另存为") appeared | PASS |
| 6 | Save email as template | Not available in New Outlook (Monarch) | SKIP |
| 7 | Forward as OFT | Not available in New Outlook (Monarch) | SKIP |
| 8 | File → `winctl click 315` (Print) | Print dialog ("打印"): printer Canon MF650C, copies, layout, color, duplex, print preview | PASS |
| 9 | File → `winctl click 316` (Open and export) | Settings → Files page: Outlook Data Files, Import, Export tabs, PST description | PASS |
| 10 | File → `winctl click 318` (Settings) | Settings → General → Language and time: language/region, date format, time format, time zone | PASS |
| 11 | `winctl click 51` → About Outlook (sub-tab in Settings) | About page: Microsoft Outlook Version, Client Version, WebView2 Version, What's new | PASS |
| 12 | File → `winctl click 320` (Exit) | Outlook closed. No Outlook window found in `winctl windows`. | PASS |

**TC2 Result: 10/12 PASS, 2 SKIP**
